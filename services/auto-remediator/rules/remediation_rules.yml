version: 1

defaults:
  enabled: true
  severity: warn
  cooldown_sec: 180

# Normalize service names into a canonical set used by dashboards/rules.
# Keys and values are treated case-insensitively and normalized to lowercase.
service_aliases:
  payment-service: payments
  payments-service: payments
  auth-service: auth
  db-service: db
  orders-service: orders

# Optional policy guards
policy:
  # Only allow remediation for the core demo services.
  # If you want to include other services, add them here.
  allowlist_services:
    - payments
    - auth
    - db
    - orders

  # Always block these targets.
  denylist_services:
    - unknown

  # Optional: restrict to supported action types.
  allowlist_action_types:
    - SCALE_UP
    - ROLLING_RESTART

rules:
  - rule_id: cpu_spike_scale_up
    match:
      incident_type: CPU_SPIKE
      service: "*"
      min_severity: warn
    action:
      action_type: SCALE_UP
      target_service: "{service}"
      parameters:
        replicas_delta: 1
        reason: "cpu spike"
    cooldown_sec: 120

  - rule_id: latency_spike_scale_up
    match:
      incident_type: LATENCY_SPIKE
      service: "*"
      min_severity: warn
    action:
      action_type: SCALE_UP
      target_service: "{service}"
      parameters:
        replicas_delta: 1
        reason: "latency spike"
    cooldown_sec: 120

  - rule_id: error_rate_rolling_restart
    match:
      incident_type: ERROR_RATE_SPIKE
      service: "*"
      min_severity: error
    action:
      action_type: ROLLING_RESTART
      target_service: "{service}"
      parameters:
        reason: "error rate spike"
    cooldown_sec: 300

  - rule_id: memory_spike_restart
    match:
      incident_type: MEMORY_SPIKE
      service: "*"
      min_severity: warn
    action:
      action_type: ROLLING_RESTART
      target_service: "{service}"
      parameters:
        reason: "memory spike"
    cooldown_sec: 300
